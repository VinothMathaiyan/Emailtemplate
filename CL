import pandas as pd
from openpyxl import load_workbook

# Function to categorize sentiment
def categorize_sentiment(score):
    if score <= -0.5:
        return "Negative"
    elif -0.5 < score <= 0.5:
        return "Neutral"
    else:
        return "Positive"

# Function to generate topic-wise sentiment summary
def generate_summary(df, sheet_name):
    summary_data = {}

    for _, row in df.iterrows():
        topics = str(row["Stages"]).split("; ")  # Split multiple topics
        sentiment_category = categorize_sentiment(row["Sentiment Score"])
        comment = str(row["Response"])

        for topic in topics:
            if topic not in summary_data:
                summary_data[topic] = {"Positive": 0, "Negative": 0, "Neutral": 0, "Aggregated Comments": []}

            # Increment sentiment category count
            summary_data[topic][sentiment_category] += 1
            summary_data[topic]["Aggregated Comments"].append(comment)

    # Convert to DataFrame
    summary_df = pd.DataFrame([
        {
            "Stages": topic,
            "Positive Count": data["Positive"],
            "Negative Count": data["Negative"],
            "Neutral Count": data["Neutral"],
            "Aggregated Comments": " | ".join(set(data["Aggregated Comments"]))  # Remove duplicate comments
        }
        for topic, data in summary_data.items()
    ])

    return summary_df

# Load processed Excel file
file_path = input("Enter the processed Excel file path: ")
df_p1266 = pd.read_excel(file_path, sheet_name="PeopleLeader_1266")
df_c1033 = pd.read_excel(file_path, sheet_name="Colleage_1033")

# Generate summaries
df_summary_p1266 = generate_summary(df_p1266, "PL1266_Topic_Summary")
df_summary_c1033 = generate_summary(df_c1033, "C1033_Topic_Summary")

# Save to the same processed file as new sheets
with pd.ExcelWriter(file_path, engine="openpyxl", mode="a") as writer:
    df_summary_p1266.to_excel(writer, sheet_name="PL1266_Topic_Summary", index=False)
    df_summary_c1033.to_excel(writer, sheet_name="C1033_Topic_Summary", index=False)

print("Summary saved in 'PL1266_Topic_Summary' and 'C1033_Topic_Summary' sheets.")
