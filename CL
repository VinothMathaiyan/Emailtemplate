import os
import json
import openpyxl

def load_qsf_file(qsf_path):
    """
    Loads the JSON data from the specified QSF file.

    Args:
        qsf_path: Path to the QSF file.

    Returns:
        A dictionary containing the JSON data from the QSF file.
    """
    try:
        with open(qsf_path, 'r') as f:
            return json.load(f)
    except FileNotFoundError:
        print(f"Error: QSF file '{qsf_path}' not found.")
        return None
    except json.JSONDecodeError:
        print(f"Error: Invalid JSON in QSF file '{qsf_path}'.")
        return None

def extract_question_ids_from_bl(qsf_data):
    """
    Extracts QuestionIDs from Block Questions (BL) in the QSF data.

    Args:
        qsf_data: A dictionary containing the JSON data from the QSF file.

    Returns:
        A list of QuestionIDs extracted from Block Questions.
    """
    question_ids = []
    for element in qsf_data.get("SurveyElements", []):
        if element.get("Element") == "BL":
            payload = element.get("Payload", {})
            for block_id, block_data in payload.items():
                if isinstance(block_data, dict) and "BlockElements" in block_data:
                    for block_element in block_data["BlockElements"]:
                        if "QuestionID" in block_element:
                            question_ids.append(block_element["QuestionID"])
    return question_ids

def write_to_excel(question_ids, file_name):
    """
    Writes the list of question IDs to an Excel file.

    Args:
        question_ids: A list of question IDs.
        file_name: The name of the Excel file to be created.
    """
    workbook = openpyxl.Workbook()
    sheet = workbook.active
    sheet.title = "Question IDs"

    for row, question_id in enumerate(question_ids, start=1):
        sheet.cell(row=row, column=1, value=question_id)

    workbook.save(file_name)

# Change directory
os.chdir(r'c:\User\file')

# Get user input
name = input("enter name: ")
file_name = f"{name}.qsf"
qsf_path = f"QSF/{file_name}"

# Load QSF data
qsf_data = load_qsf_file(qsf_path)

# Extract QuestionIDs from BL
if qsf_data:
    question_ids = extract_question_ids_from_bl(qsf_data)

    # Write question IDs to Excel
    output_file_name = f"{name}_question_ids.xlsx"
    write_to_excel(question_ids, output_file_name)

    print(f"Question IDs from BL in {file_name}: {question_ids}")
    print(f"Question IDs written to {output_file_name}")
