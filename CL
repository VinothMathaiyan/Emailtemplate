import json
import pandas as pd
import re

def load_qsf_file(qsf_file):
    with open(qsf_file, 'r', encoding='utf-8-sig') as file:
        data = json.load(file)
    return data

def clean_html(raw_html):
    clean_text = re.sub(r'<[^>]+>', '', raw_html)  # Remove HTML tags
    clean_text = re.sub(r'&nbsp;', ' ', clean_text)  # Replace &nbsp; with space
    clean_text = re.sub(r'\s+', ' ', clean_text).strip()  # Remove extra whitespace
    return clean_text

def extract_questions(data):
    questions = []
    for element in data['SurveyElements']:
        if element['Element'] == 'SQ':
            question = element['Payload']
            question_id = question.get('QuestionID', '')
            question_text = clean_html(question.get('QuestionText', ''))
            questions.append((question_id, question_text))
    
    print("Extracted Questions:", questions)  # Debugging line
    return questions

def extract_question_order(data):
    block_elements = {}
    for element in data['SurveyElements']:
        if element['Element'] == 'BL':
            block_id = element['PrimaryAttribute']
            block_elements[block_id] = element['Payload'].get('BlockElements', [])
    
    question_order = []
    for block_id, elements in block_elements.items():
        for item in elements:
            if item['Type'] == 'Question':
                question_order.append(item['QuestionID'])
    
    print("Block Elements:", block_elements)  # Debugging line
    print("Question Order:", question_order)  # Debugging line
    return question_order

def reorder_questions(questions, question_order):
    question_dict = {qid: qtext for qid, qtext in questions}
    ordered_questions = [(question_order.index(qid), question_dict[qid]) for qid in question_order if qid in question_dict]
    
    print("Ordered Questions:", ordered_questions)  # Debugging line
    return ordered_questions

def save_to_excel(questions, output_file):
    df = pd.DataFrame(questions, columns=['Order', 'QuestionText'])
    df.to_excel(output_file, index=False)

if __name__ == "__main__":
    qsf_file = 'd:/Hackaton/EXCELtoQSF/QualtricsExported_template_formatted.qsf'
    output_file = 'output.xlsx'
    
    data = load_qsf_file(qsf_file)
    questions = extract_questions(data)
    question_order = extract_question_order(data)
    ordered_questions = reorder_questions(questions, question_order)
    save_to_excel(ordered_questions, output_file)
    print(f"Questions have been successfully exported to {output_file}")
