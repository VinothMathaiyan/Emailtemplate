import json
import pandas as pd

def extract_questions(qsf_file):
    with open(qsf_file, 'r', encoding='utf-8-sig') as file:
        data = json.load(file)
    
    # Extract the survey flow to get the order of questions
    survey_flow = None
    for element in data['SurveyElements']:
        if element['Element'] == 'FL':
            survey_flow = element['Payload']['Flow']
            break
    
    if survey_flow is None:
        raise KeyError("Survey flow not found in the QSF file.")
    
    question_order = []
    
    def parse_flow(flow):
        for item in flow:
            if item['Type'] == 'Block':
                parse_flow(item['Flow'])
            elif item['Type'] == 'Question':
                question_order.append(item['ID'])
    
    parse_flow(survey_flow)
    
    print("Question Order:", question_order)  # Debugging line
    
    # Extract questions and maintain their order
    questions = []
    for element in data['SurveyElements']:
        if element['Element'] == 'SQ':
            question = element['Payload']
            question_id = question.get('QuestionID', '')
            question_text = question.get('QuestionText', '')
            if question_id in question_order:
                questions.append((question_order.index(question_id), question_text))
    
    print("Extracted Questions:", questions)  # Debugging line
    
    # Sort questions by their order in the survey
    questions.sort(key=lambda x: x[0])
    return questions

def save_to_excel(questions, output_file):
    df = pd.DataFrame(questions, columns=['Order', 'QuestionText'])
    df.to_excel(output_file, index=False)

if __name__ == "__main__":
    qsf_file = 'path/to/your/survey.qsf'
    output_file = 'output.xlsx'
    
    questions = extract_questions(qsf_file)
    save_to_excel(questions, output_file)
    print(f"Questions have been successfully exported to {output_file}")
