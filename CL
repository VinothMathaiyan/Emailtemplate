# Function to Map Topics to Responses
def map_topics(response):
    response_tfidf = vectorizer.transform([response])  # Convert response to TF-IDF
    similarities = cosine_similarity(response_tfidf, stages_tfidf)  # Compute cosine similarity
    
    best_matches = np.where(similarities[0] > 0.3)[0]  # Updated Threshold = 0.3
    
    # Debugging: Print similarity scores for sample responses
    if len(best_matches) == 0:
        print(f"No match found for response: {response}")
    
    mapped_topics = [df_stages.iloc[i, 1] for i in best_matches]  # Picking topics from the correct column

    return "; ".join(mapped_topics) if mapped_topics else "No Match"

# Apply Topic Mapping
df_p1266["Stages"] = df_p1266["Expanded Response"].astype(str).apply(map_topics)
df_c1033["Stages"] = df_c1033["Expanded Response"].astype(str).apply(map_topics)
